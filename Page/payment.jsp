<%@ page contentType="text/html;charset=UTF-8" %>
<%@ page import="java.text.*" %>
<%@ page import="java.sql.*" %>
<%@ page import="java.util.*" %>
<%
  // Ê™¢Êü•Áî®Êà∂ÊòØÂê¶ÁôªÂÖ•
  String email = (String) session.getAttribute("userEmail");
  boolean isLoggedIn = (email != null);
  // Ê™¢Êü•Áî®Êà∂ÊòØÂê¶ÁôªÂÖ•
  if (!isLoggedIn) {
    response.sendRedirect("./index.jsp"); // Ëã•Êú™ÁôªÈåÑÂâáÈáçÂÆöÂêëÂà∞È¶ñÈ†Å
    return;
  }

  // Ë®≠ÁΩÆÁ∑©Â≠òÊéßÂà∂È†≠
  response.setHeader("Cache-Control", "no-cache, no-store, must-revalidate");
  response.setHeader("Pragma", "no-cache");
  response.setDateHeader("Expires", 0);
%>

<!doctype html>
<html lang="en" data-bs-theme="auto">

  <!-- Ê≠§ÁÇ∫ÁôªÂÖ•ÂæåÁöÑ‰ªãÈù¢ -->

  <head>
    <script src="./assets/js/color-modes.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Hugo 0.122.0">

    <!-- Á∂≤È†ÅÊ®ôÈ°å -->
    <title> ÂêÉË≤®ÈÅì| ÂêÉË≤®ÁöÑÂ∞àÂ±¨ÈñÄÈÅì </title> 

    <!-- ÂºïÁî® Bootstrap Â•ó‰ª∂---> 
    <link rel="canonical" href="https://getbootstrap.com/docs/5.3/examples/carousel/">
    <link rel="canonical" href="https://getbootstrap.com/docs/5.3/examples/headers/">
    <link rel="canonical" href="https://getbootstrap.com/docs/5.3/examples/masonry/">
    <link rel="canonical" href="https://getbootstrap.com/docs/5.3/examples/footers/">
    <link rel="canonical" href="https://getbootstrap.com/docs/5.3/examples/navbars/">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3">
    <link href="./assets/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- ‰ΩøÁî®font-awesomeÁ∑ö‰∏äÂÖç‰∏ãËºâÂúñÊ®ô(icon) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" integrity="sha512-5A8nwdMOWrSz20fDsjczgUidUBR8liPYU+WymTZP1lmY9G6Oc7HlZv156XqnsgNUzTyMefFTcsFH/tnJE/+xBg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- ÁôªÂÖ•Ê¨Ñ‰ΩçÂºïÁî®Á∑ö‰∏äË≥áÊ∫ê -->
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> <!-- header -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> <!-- header -->
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3">

    <!-- ÂºïÁî® ÊÄùÊ∫êÈªëÈ´îÂ≠óÂΩ¢ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100..900&display=swap" rel="stylesheet">

    <!-- Êú¨htmlÊ®£ÂºèÊ™î -->
    <link href="./stylesheets/payment.css" rel="stylesheet">

    <!-- ÁôªÂÖ•Ë®ªÂÜäÊ®£ÂºèÊ™î  -->
    <link rel="stylesheet" href="./stylesheets/LoginArea.css"> 

    <!-- Ë≥ºÁâ©ËªäÊ®£ÂºèÊ™î -->
    <link rel="stylesheet" href="./stylesheets/BuyCart.css">

  </head>

  <body>

    <!-- ‰∏äÊñπÊ¨Ñ‰Ωç (Â∑•ÂÖ∑Ê¨Ñ)
    ================================================== -->

      <!-- Â∑•ÂÖ∑Ê¨ÑÁ¨¨‰∏ÄÊ¨Ñ -->
      <nav class="navbar navbar-expand-lg"> 

        <!-- Â∑•ÂÖ∑Ê¨ÑÁ¨¨‰∏ÄÊ¨ÑÂÖßÂÆπÁâ©ÂÆπÂô® -->
        <div class="row navOneRow">

          <!-- „ÄêÂúñÊ®ôlogo„Äë-->
          <div class="col-sm navLogoCol">
            <div class="navLogo" >
              <!-- Logo ÈªûÊìäÂõûÂà∞ÁôªÂÖ•Âæå‰∏ªÈ†Å -->
              <a href="./index_LoggedIn.jsp">
              <img src="./picture/material/navPic/navLogo.png" alt="navLogoPic">
              </a>
            </div>
          </div>
          

          <!-- ÊêúÂ∞ãÊ¨Ñ -->
          <div class="col-sm searchBarCol">

            <form class="d-flex" action="./SearchProduct_LoggedIn.jsp" method="get" style="width:750px;">
              <input id="searchBar" class="form-control me-2 searchBar" name="keyword" type="search" placeholder="üîç ÊêúÂ∞ã" aria-label="Search">
          
              <script>
                  // Âú®Ëº∏ÂÖ•Ê°ÜÁç≤ÂæóÁÑ¶ÈªûÊôÇÔºåÊ∑ªÂä†ÁâπÂÆöÁöÑÊ®£Âºè
                  document.getElementById("searchBar").addEventListener("focus", function() {
                      this.classList.add("focused");
                  });
          
                  // Âú®Ëº∏ÂÖ•Ê°ÜÂ§±ÂéªÁÑ¶ÈªûÊôÇÔºåÁßªÈô§ÁâπÂÆöÁöÑÊ®£Âºè
                  document.getElementById("searchBar").addEventListener("blur", function() {
                      this.classList.remove("focused");
                  });
              </script>
          </form>
            
          </div>

          <!-- Âè≥ÂÅ¥ÂÖ©ÂÄãÊåâÈàïÊ¨Ñ‰Ωç -->
          <div class="col-sm BuyCart_and_Account" style="padding-left: 20px;">
            
            <!-- „ÄêË≥ºÁâ©Ëªä„Äë -->
            <div id="cart">

                <!-- Ë≥ºÁâ©ËªäÊåâÈàï --> 
                  <button onclick="openNav()".style.display='block' type="button" class="btn btn-light" style="width: auto;height:auto;">
                      <i class="fa fa-shopping-cart" aria-hidden="true" style="font-size: 22px;"></i>
                  </button>
            
                <!-- ÊóÅÈÇäÈ°ØÁ§∫‰πãË≥ºÁâ©ËªäÁïåÈù¢ -->
                <div id="mySidebar" class="sidebar">
  
                  <!-- Ë≥ºÁâ©ËªäÈ†ÅÈù¢Âè≥ÈÇä‰πãÂ§ßÂèâÂèâ-->
                  <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
  
                  <div class="sidebarinner">
  
                    
  
                        <div class="container">
  
                            <%
                            String memberId = String.valueOf(session.getAttribute("MemberID"));
                            if (memberId == null) {
                                out.println("<p>Ë´ãÂÖàÁôªÂÖ•‰ª•Êü•ÁúãË≥ºÁâ©Ëªä„ÄÇ</p>");
                                return;
                            }
  
                            int totalQuantity = 0; // Á∏ΩÊï∏Èáè
                            int totalPrice = 0; // Á∏ΩÂÉπÊ†º
  
                            Connection ProductConn = null;
                            PreparedStatement ProductPstmt = null;
                            ResultSet ProductRs = null;
                            try {
                                Class.forName("com.mysql.cj.jdbc.Driver");
                                ProductConn = DriverManager.getConnection("jdbc:mysql://localhost:3306/FinalProject", "root", "Ray_930715");
  
                                String sql = "SELECT c.cartID, c.productID, c.quantity, i.ProductName, i.Price, i.Producturl FROM cart c JOIN inventoryquantity i ON c.productID = i.ProductID WHERE c.MemberID = ?";
                                ProductPstmt = ProductConn.prepareStatement(sql);
                                ProductPstmt.setInt(1, Integer.parseInt(memberId));
                                ProductRs = ProductPstmt.executeQuery();
  
                                if (!ProductRs.isBeforeFirst()) {
                                    out.println("<p>ÊÇ®ÁöÑË≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ</p>");
                                } else {
                                    while (ProductRs.next()) {
                                        int cartID = ProductRs.getInt("cartID"); // Ensure cartID is retrieved
                                        String pid = ProductRs.getString("productID");
                                        int quantity = ProductRs.getInt("quantity");
                                        String productName = ProductRs.getString("ProductName");
                                        int price = ProductRs.getInt("Price");
                                        String imageUrl = ProductRs.getString("Producturl");
  
                                        totalQuantity += quantity;
                                        totalPrice += price * quantity;
                            %>
                            
                            <div class="cart-p">
                              <img src="<%= imageUrl %>" alt="<%= productName %>">
                              <div>
                                  <div class="cp1">   <!--ÂïÜÂìÅÂêçÁ®±-->
                                      <h1><%= productName %></h1>
                                  </div>
                                  <!-- Ë≥ºÁâ©ËªäË°®ÂñÆ -->
                                  <form action="./changeCartItem.jsp" method="post" class="quantity-form">
                                      <div class="cp2" data-min="1" data-max="50"> <!-- Êï∏ÈáèÂ¢ûÊ∏õ minÊúÄÂ∞èË≥ºË≤∑Êï∏Èáè„ÄÅmaxÊúÄÂ§ßË≥ºË≤∑Êï∏Èáè -->
                                          <input class="min" type="button" value="&minus;" onclick="updateQuantity(this, -1)" /> <!-- ' &minus; 'ÊòØÊ∏õËôü -->
                                          <input class="quantity" type="text" name="quantity" value="<%= quantity %>" oninput="validateQuantity(this)" />
                                          <input class="add" type="button" value="+" onclick="updateQuantity(this, 1)" /> 
                                      </div>
                                      <input type="hidden" name="cartID" value="<%= cartID %>">
                                      <input type="hidden" name="action" value="update">
                                  </form>
                              </div>
                              <div class="cp3">   <!-- ÂïÜÂìÅÂÉπÊ†º -->
                                  <p>NT$ <%= price %></p>
                              </div>
                              <form action="./changeCartItem.jsp" method="post" style="display:inline;">
                                  <input type="hidden" name="cartID" value="<%= cartID %>">
                                  <input type="hidden" name="action" value="delete">
                                  <button type="submit">&times;</button> <!-- Âà™Èô§ÂïÜÂìÅÊåâÈàï '&times;'ÊòØÂèâÂèâÁ¨¶Ëôü -->
                              </form>
                          </div>
                            <%
                                    }
                                }
                            } catch (Exception e) {
                                e.printStackTrace();
                            } finally {
                                if (ProductRs != null) try { ProductRs.close(); } catch (SQLException ignore) {}
                                if (ProductPstmt != null) try { ProductPstmt.close(); } catch (SQLException ignore) {}
                                if (ProductConn != null) try { ProductConn.close(); } catch (SQLException ignore) {}
                            }
                            %>
                          <!-- Ë≥ºË≤∑Êï∏ÈáèÂ¢ûÊ∏õÊéßÂà∂ -->
                          <script>
                            function updateQuantity(button, delta) {
                                const form = button.closest('.quantity-form');
                                const quantityInput = form.querySelector('.quantity');
                                let currentValue = parseInt(quantityInput.value);
                        
                                const min = parseInt(button.closest('.cp2').getAttribute('data-min'));
                                const max = parseInt(button.closest('.cp2').getAttribute('data-max'));
                        
                                if (!isNaN(currentValue)) {
                                    const newValue = currentValue + delta;
                                    if (newValue >= min && newValue <= max) {
                                        quantityInput.value = newValue;
                                        form.submit();
                                    }
                                }
                            }
                        
                            function validateQuantity(input) {
                                const form = input.closest('.quantity-form');
                                let value = input.value.replace(/[^0-9]/g, '');
                                const cp2 = input.closest('.cp2');
                                const max = parseInt(cp2.getAttribute('data-max'));
                        
                                if (value > max) {
                                    alert(`ÊúÄÂ§öÂè™ËÉΩË≥ºË≤∑ ${max} ÂÄã`);
                                    input.value = max;
                                } else {
                                    input.value = value;
                                }
                        
                                form.submit();
                            }
                        </script>
                        
  
                          <!-- Ë®àÁÆóÁ∏ΩÂÉπ -->
                          <div class="cart-total">
                            <p>Á∏ΩÈáëÈ°ç<p>
                            <p class="r">NT$ <%= totalPrice %></p>
                          </div>
  
                          <!-- Ë≥ºÁâ©ËªäÊúÄÂæåÊåâÈàï (ÁπºÁ∫åË≥ºÁâ©/ÁµêÂ∏≥Âéª)-->
                          <div class="cart-but row" >
                            <div class="col">
                                <input type="button" value="ÁπºÁ∫åË≥ºÁâ©" class="Continu_OR_Checkout_Btn" onclick="closeNav()">
                            </div>
                            <div class="col">
                                <input type="button" value="Ë≤∑ÂñÆÂéª" class="Continu_OR_Checkout_Btn" onclick="location.href='./payment.jsp'">
                            </div>
                        </div>
                        </div>
                  </div>
                </div>

            <!-- „ÄêÊúÉÂì°Ë®ªÂÜäÁôªÂÖ•„Äë -->
            <%

            
                // Ë®≠ÁΩÆË≥áÊñôÂ∫´ÈÄ£Êé•Áõ∏ÈóúËÆäÊï∏
                Connection conn = null;
                PreparedStatement pstmt = null;
                ResultSet rs = null;
            
                String userName = "";
                String userPhone = "";
                String userBirthday = "";
                String userAddress = "";
            
                try {
                    // ÈÄ£Êé•Âà∞ MySQL Ë≥áÊñôÂ∫´
                    String url = "jdbc:mysql://localhost:3306/FinalProject?serverTimezone=UTC";
                    Class.forName("com.mysql.cj.jdbc.Driver");
                    conn = DriverManager.getConnection(url, "root", "Ray_930715");
            
                    // Áç≤ÂèñÁî®Êà∂Ë≥áÊñô
                    String sql = "SELECT MemberName, MemberPhone, BirthdayDate, Address FROM membership WHERE MemberAccount = ?";
                    
                    // ‰ΩøÁî® PreparedStatement Èò≤Ê≠¢ SQL Ê≥®ÂÖ•
                    pstmt = conn.prepareStatement(sql);
                    pstmt.setString(1, email);
            
                    // Âü∑Ë°åÊü•Ë©¢Êìç‰Ωú
                    rs = pstmt.executeQuery();
            
                    if (rs.next()) {
                        userName = rs.getString("MemberName");
                        userPhone = rs.getString("MemberPhone");
                        userBirthday = rs.getString("BirthdayDate");
                        userAddress = rs.getString("Address");
                    }
            
                    // ÈóúÈñâË≥áÊñôÂ∫´ÈÄ£Êé•
                    conn.close();
                } catch (SQLException sExec) {
                    out.println("SQL ÈåØË™§: " + sExec.toString());
                }
            %>
            <!-- ÊúÉÂì°Ë®ªÂÜäËàáÁôªÂÖ•ÊåâÈàï -->
            <button onclick="location.href='./memberPage.jsp'" type="button" class="btn btn-light" style="width: auto;height:auto;font-weight: bold;margin-left:10px;">
              <i class="fa fa-user" aria-hidden="true" style="font-size: 22px;margin-right: 5px;"></i>
              <%= userName %> ÊÇ®Â•ΩÔºÅ
            </button>

            <!-- ÁôªÂá∫ÊåâÈàï -->
            <button onclick="location.href='./index.jsp'" type="button" class="btn btn-danger" style="width: auto;height:auto;font-weight: bold;margin-left:10px;">
              <i class="fa fa-sign-out" aria-hidden="true" style="font-size: 16px;margin-right: 5px;"></i>
              ÁôªÂá∫
            </button>

            <!-- Ë≥ºÁâ©ËªäÊâÄÈúÄjsÊ™î -->
            <script src="./javascript/h.js" charset="utf-8"></script>

          </div>

        </div>

        
      </nav>

      <!-- Â∑•ÂÖ∑Ê¨ÑÁ¨¨‰∫åÊ¨Ñ -->
      <nav class="navbar navbar-expand-lg navbar-black bg-black" aria-label="Tenth navbar example"> 

        <div class="container-fluid" style="background-color: #f7f7f7">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample08" aria-controls="navbarsExample08" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
          
          <!-- ‰∏ãÊãâÂºèÈÅ∏ÂñÆ -->
          <div class="collapse navbar-collapse justify-content-md-center navCol-2" id="navbarsExample08"> 

            <li class="nav-item dropdown">
                <a class="nav-link " href="#" data-bs-toggle="dropdown" aria-expanded="false" style="padding: 20px;color: #6e573a;font-weight: 1000;font-size: 18px;">ÂïÜÂìÅÁÄèË¶Ω</a>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="./AllProduct_LoggedIn.jsp">ÊâÄÊúâÂïÜÂìÅ</a></li>
                  <li><a class="dropdown-item" href="./AllProduct_LoggedIn.jsp#noodle">Ê≥°È∫µ</a></li>
                  <li><a class="dropdown-item" href="./AllProduct_LoggedIn.jsp#drinks">È£≤Êñô</a></li>
                  <li><a class="dropdown-item" href="./AllProduct_LoggedIn.jsp#snacks">Èõ∂È£üÁ≥ñÊûú</a></li>
                </ul>
              </li>
  
              <li class="nav-item dropdown">
                <a class="nav-link " href="#" data-bs-toggle="dropdown" aria-expanded="flase" style="padding: 20px;color: #6e573a;font-weight: 1000;font-size: 18px;">ÈóúÊñºÊàëÂÄë</a>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="./aboutus_LoggedIn.jsp#brandConcept">ÂìÅÁâåÁêÜÂøµ</a></li>
                  <li><a class="dropdown-item" href="./aboutus_LoggedIn.jsp#MemberIntro">ÊàêÂì°‰ªãÁ¥π</a></li>
                </ul>
              </li>
  

            <li class="nav-item dropdown">
              <a class="nav-link" href="#FooterArea"  aria-expanded="false" style="padding: 20px;color: #6e573a;font-weight: 1000;font-size: 18px;">ËÅØÁµ°ÊàëÂÄë</a>
            </li>

          </div>

        </div>
      </nav>


    <!-- Êî∂‰ª∂‰∫∫ËàáÂØÑÈÄÅË≥áË®ä
    ================================================== -->

    <section class="paymentArea"> <!-- paymentArea ÁÇ∫ÂÖ©section‰πãÂÖ±Áî®Â§ßÂÆπÂô® -->

        <!-- Êî∂‰ª∂‰∫∫ËàáÂØÑÈÄÅË≥áË®ä‰πãÂÆπÂô® -->
        <section class="payment-cont">
            
        <!-- ÁµêÂ∏≥Ë°®ÂñÆ -->
        <form method="post" action="./order.jsp">

            <!-- Êî∂‰ª∂‰∫∫ËàáÂØÑÈÄÅË≥áË®ä‰πãÊ®ôÈ°å -->
            <div class="payment-header">
                <iconify-icon icon="mdi:truck-delivery-outline"></iconify-icon>
                <h5>Êî∂‰ª∂‰∫∫/ÂØÑÈÄÅË≥áË®ä</h5>
            </div>

            <!-- Êî∂‰ª∂‰∫∫ËàáÂØÑÈÄÅË≥áË®ä‰πãÂÆπÂô®2 -->
            <div class="payment-info">

                <div id="deliveryForm" class="needs-validation" novalidate>
                    <div class="form-group" style="margin-bottom: 30px;">
                        <label for="name" class="required">Êî∂‰ª∂‰∫∫ÂßìÂêç :</label>
                        <input type="text" class="form-control" id="name" placeholder="Ë´ãËº∏ÂÖ•Êú¨Âêç" required>
                        
                    </div>
                    <div class="form-group" style="margin-bottom: 30px;">
                        <label for="phone" class="required">Êî∂‰ª∂‰∫∫ÈõªË©± :</label>
                        <input type="tel" class="form-control" id="phone" placeholder="Ë´ãËº∏ÂÖ•ÈõªË©±" required>
                        
                    </div>
                    <div class="form-group" style="margin-bottom: 30px;">
                        <label for="address" class="required">Âú∞ÂùÄ :</label>
                        <input type="text" class="form-control" id="address" placeholder="Ë´ãËº∏ÂÖ•Âú∞ÂùÄ" required>
                        
                    </div>
                    <div class="form-group">
                        <label for="delivery">ÂØÑÈÄÅÊñπÂºè :</label>
                        <select id="delivery" class="option-control" required>
                            <option value="" selected disabled>ÈÅ∏ÊìáÂØÑÈÄÅÊñπÂºè</option>
                            <option value="7-11">7-11</option>
                            <option value="ÂÖ®ÂÆ∂">ÂÖ®ÂÆ∂</option>
                            <option value="ËêäÁàæÂØå">ËêäÁàæÂØå</option>
                            <option value="OK">OK</option>
                            <option value="ÂÆÖÈÖç">ÂÆÖÈÖç</option>
                        </select>
                        <select id="city" class="option-control" required>
                            <option value="" selected disabled>Á∏£Â∏Ç</option>
                            <option value="Âè∞ÂåóÂ∏Ç">Âè∞ÂåóÂ∏Ç</option>
                            <option value="Êñ∞ÂåóÂ∏Ç">Êñ∞ÂåóÂ∏Ç</option>
                            <option value="Ê°ÉÂúíÂ∏Ç">Ê°ÉÂúíÂ∏Ç</option>
                            <option value="Âè∞‰∏≠Â∏Ç">Âè∞‰∏≠Â∏Ç</option>
                            <option value="Âè∞ÂçóÂ∏Ç">Âè∞ÂçóÂ∏Ç</option>
                            <option value="È´òÈõÑÂ∏Ç">È´òÈõÑÂ∏Ç</option>
                        </select>
                        <select id="district" class="option-control" required>
                            <option value="" selected disabled>ÂçÄÂüü</option>
                        </select>
                        <select id="store" required class="option-control">
                            <option value="" selected disabled>ÈñÄÂ∏Ç</option>
                            <option value="ÈÇÑ‰∏≠Â∫ó">ÈÇÑ‰∏≠Â∫ó</option>
                            <option value="Âª∫ÂúãÂ∫ó">Âª∫ÂúãÂ∫ó</option>
                            <option value="ÊüèÂæ∑Â∫ó">ÊüèÂæ∑Â∫ó</option>
                            <option value="‰∏≠ÂåóÂ∫ó">‰∏≠ÂåóÂ∫ó</option>
                            <option value="ÂÖÉÊô∫Â∫ó">ÂÖÉÊô∫Â∫ó</option>
                        </select>

                        <!-- ÂçÄÂüüÈÅ∏ÊìáË®≠ÂÆö -->
                        <script>
                            document.addEventListener("DOMContentLoaded", function() {
                                const citySelect = document.getElementById("city");
                                const districtSelect = document.getElementById("district");

                                const districts = {
                                    "Âè∞ÂåóÂ∏Ç": ["‰∏≠Ê≠£ÂçÄ", "Â§ßÂêåÂçÄ", "‰∏≠Â±±ÂçÄ", "ÊùæÂ±±ÂçÄ", "Â§ßÂÆâÂçÄ"],
                                    "Êñ∞ÂåóÂ∏Ç": ["ÊùøÊ©ãÂçÄ", "‰∏âÈáçÂçÄ", "‰∏≠ÂíåÂçÄ", "Ê∞∏ÂíåÂçÄ", "Êñ∞ËéäÂçÄ"],
                                    "Ê°ÉÂúíÂ∏Ç": ["Ê°ÉÂúíÂçÄ", "‰∏≠Â£¢ÂçÄ", "ÂÖ´Âæ∑ÂçÄ", "Âπ≥ÈéÆÂçÄ", "ÈæúÂ±±ÂçÄ", "Â§ßÊ∫™ÂçÄ"],
                                    "Âè∞‰∏≠Â∏Ç": ["Ë±êÂéüÂçÄ","Â§ßÈáåÂçÄ", "Â§™Âπ≥ÂçÄ", "Êù±Âã¢ÂçÄ", "Ê≤ôÈπøÂçÄ", "Ê¢ßÊ£≤ÂçÄ", "Ê∏ÖÊ∞¥ÂçÄ", "Â§ßÁî≤ÂçÄ", "ÈúßÂ≥∞ÂçÄ", "ÁÉèÊó•ÂçÄ"],
                                    "Âè∞ÂçóÂ∏Ç": ["‰∏≠Ë•øÂçÄ", "Êù±ÂçÄ", "ÂçóÂçÄ", "ÂåóÂçÄ", "ÂÆâÂπ≥ÂçÄ"],
                                    "È´òÈõÑÂ∏Ç": ["Êñ∞ËààÂçÄ", "ÂâçÈáëÂçÄ", "ËãìÈõÖÂçÄ", "ÈπΩÂüïÂçÄ", "ÈºìÂ±±ÂçÄ"]
                                };

                                citySelect.addEventListener("change", function() {
                                    const selectedCity = citySelect.value;
                                    while (districtSelect.options.length > 1) {
                                        districtSelect.remove(1);
                                    }

                                    if (districts[selectedCity]) {
                                        districts[selectedCity].forEach(function(district) {
                                            const option = document.createElement("option");
                                            option.value = district;
                                            option.text = district;
                                            districtSelect.add(option);
                                        });
                                    }
                                });
                            });
                        </script>

                    </div>

                    
                        <!-- ÂÖ∂‰ªñËº∏ÂÖ•Ê°Ü -->
                        <fieldset class="fieldset-legend">
                            <legend>Ë®ÇÂñÆÂÇôË®ª</legend>
                            <textarea name="remark" rows="10" cols="30" style="height: 160px; width: 550px; resize: none;"></textarea>
                        </fieldset>
                        <!-- ÂÖ∂‰ªñËº∏ÂÖ•Ê°Ü -->

                </div>
                
            </div>
        </section>
        
    <!-- ‰ªòÊ¨æË≥áË®ä
    ================================================== -->

    <section class="payment-cont">

        <!-- payment header -->
        <div class="payment-header">
            <iconify-icon icon="mdi:account-payment-outline"></iconify-icon>
            <h5>‰ªòÊ¨æË≥áË®ä</h5>
        </div>

        <!-- payment information -->
        <div class="payment-info">
            <div id="paymentForm" class="needs-validation" novalidate>
                <div class="form-group">
                    <label for="payment-method">‰ªòÊ¨æÊñπÂºè :</label>
                    <label><input type="radio" name="payment-method" value="Ë≤®Âà∞‰ªòÊ¨æ"> Ë≤®Âà∞‰ªòÊ¨æ</label>
                    <label><input type="radio" name="payment-method" value="Á∑ö‰∏ä‰ªòÊ¨æ" checked> Á∑ö‰∏ä‰ªòÊ¨æ</label>
                </div>

                <div class="separator">
                    <span class="separatorText">Á∑ö‰∏ä‰ªòÊ¨æË´ãÂ°´ÂØ´‰ª•‰∏ãË≥áË®ä</span>
                </div>

                <fieldset class="fieldset-legend" style="margin-top: 50px;">
                    <legend>‰ø°Áî®Âç°Ë≥áË®ä</legend>
                    <div class="paymentInfoInputs">
                        <div class="form-group">
                            <label for="credit-card">‰ø°Áî®Âç°ËôüÁ¢º</label>
                            <input type="number" class="pay-form form-control" id="credit-card" placeholder="‰ø°Áî®Âç°ËôüÁ¢º" required style="margin-top: 10px;">
                        </div>
                        <div class="inline-inputs">
                            <div class="form-group" style="width: 75%;">
                                <label for="expiry-date">Âà∞ÊúüÊó•<br>ÂÆâÂÖ®Á¢º</label>
                                <input type="text" class="pay-form form-control" id="expiry-date" style="width:60%;" placeholder="Âà∞ÊúüÊó• ÔºàMM/YYÔºâ" required>
                            </div>
                            <div class="form-group" style="width: 25%;">
                                <input type="password" class="pay-form form-control" id="securitynum" style="text-align: center;" placeholder="ÂÆâÂÖ®Á¢º" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cardholder-name">ÊåÅÂç°‰∫∫ÂßìÂêç</label>
                            <input type="text" class="pay-form form-control" id="cardholder-name" placeholder="ÊåÅÂç°‰∫∫ÂßìÂêç" required>
                        </div>
                    </div>
                </fieldset>

                <div class="smallnotes">*ÊÇ®ÁöÑ‰ø°Áî®Âç°Ë≥áË®äÊúÉË¢´Âö¥Ê†º‰øùË≠∑*</div>
            </div>

        </div>

    </section>

    <%
    try {
        Class.forName("com.mysql.cj.jdbc.Driver");
        ProductConn = DriverManager.getConnection("jdbc:mysql://localhost:3306/FinalProject", "root", "Ray_930715");

        if (memberId != null) {
            String sql = "SELECT c.cartID, c.productID, c.quantity, i.ProductName, i.Price, i.Producturl FROM cart c JOIN inventoryquantity i ON c.productID = i.ProductID WHERE c.MemberID = ?";
            ProductPstmt = ProductConn.prepareStatement(sql);
            ProductPstmt.setInt(1, Integer.parseInt(memberId));
            ProductRs = ProductPstmt.executeQuery();

            while (ProductRs.next()) {
                int cartID = ProductRs.getInt("cartID");
                String pid = ProductRs.getString("productID");
                int quantity = ProductRs.getInt("quantity");
                String ProductName = ProductRs.getString("ProductName");
                int price = ProductRs.getInt("Price");
                String Producturl = ProductRs.getString("Producturl");

                totalQuantity += quantity;
                totalPrice += price * quantity;
    %>

        
        <%
        Integer productId = (Integer) session.getAttribute("productId");
        Integer productPrice = (Integer) session.getAttribute("productPrice");
        Integer totalprice = (Integer) session.getAttribute("totalprice");
        String remark = request.getParameter("remark");
        java.util.Date currentDate = new java.util.Date();
        SimpleDateFormat dateFormatter = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        String formattedDate = dateFormatter.format(currentDate);
    %>
        <input type="hidden" name="cartID" value="<%= cartID %>">
        <input type="hidden" name="date" value="<%= formattedDate %>">
        <input type="hidden" name="MemberID" value="<%= session.getAttribute("MemberID") %>">
        <input type="hidden" name="productId" value="<%= pid %>">
        <input type="hidden" name="quantity" value="<%= quantity %>">
        <input type="hidden" name="productPrice" value="<%= price %>">
        <input type="hidden" name="totalprice" value="<%= totalPrice %>">
        <input type="hidden" name="remark" value="<%= remark %>">
        <input type="hidden" name="Producturl" value="<%= Producturl %>">
        <input type="hidden" name="ProductName" value="<%= ProductName %>">
        <%
            }
        }
    } catch (Exception e) {
        e.printStackTrace();
    } finally {
        if (ProductRs != null) try { ProductRs.close(); } catch (SQLException e) { e.printStackTrace(); }
        if (ProductPstmt != null) try { ProductPstmt.close(); } catch (SQLException e) { e.printStackTrace(); }
        if (ProductConn != null) try { ProductConn.close(); } catch (SQLException e) { e.printStackTrace(); }
    }
    %>

    <div class="submitarea">
        <button id="checkoutButton" class="paymentbtn">ÁµêÂ∏≥</button>
        <script>
            document.getElementById("checkoutButton").addEventListener("click", function() {
                document.getElementById("paymentForm").submit();
            });
        </script>
    </div>

    </form>

    <script>

    // Ë≤®Âà∞‰ªòÊ¨æËàáÁ∑ö‰∏ä‰ªòÊ¨æ‰πã‰ø°Áî®Âç°Ê¨Ñ‰ΩçÔºåÂøÖÂ°´ËàáÂê¶Ë®≠ÂÆö
    document.addEventListener('DOMContentLoaded', function() {
    const paymentMethodRadios = document.querySelectorAll('input[name="payment-method"]');
    const creditCardInputs = document.querySelectorAll('#credit-card, #expiry-date, #securitynum, #cardholder-name');

    function updateRequiredAttributes() {
        const selectedPaymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
        if (selectedPaymentMethod === 'Á∑ö‰∏ä‰ªòÊ¨æ') {
        creditCardInputs.forEach(input => {
            input.setAttribute('required', 'required');
        });
        } else {
        creditCardInputs.forEach(input => {
            input.removeAttribute('required');
        });
        }
    }

    paymentMethodRadios.forEach(radio => {
        radio.addEventListener('change', updateRequiredAttributes);
    });

    // Initialize the display based on the initial selection
    updateRequiredAttributes();
    });

    // Âà∞ÊúüÊó•Ë®≠ÁΩÆÁÇ∫È†êË®≠Ê†ºÂºè(MM/YY)
    document.getElementById('expiry-date').addEventListener('input', function(e) {
    let input = e.target.value;
    if (/[^0-9\/]/.test(input)) {
        e.target.value = input.replace(/[^0-9\/]/g, '');
        return;
    }
    if (input.length === 2 && !input.includes('/')) {
        e.target.value = input + '/';
    } else if (input.length === 3 && input[2] !== '/') {
        e.target.value = input.slice(0, 2) + '/' + input[2];
    }
    if (input.length > 5) {
        e.target.value = input.slice(0, 5);
    }
    });

    /* ËôïÁêÜÊú™Â°´ÂØ´ÂÅµÊ∏¨‰∫ã‰ª∂ */
    (function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        Array.prototype.filter.call(forms, function(form) {
        form.addEventListener('submit', function(event) {
            if (form.checkValidity() === false) {
            event.preventDefault();
            event.stopPropagation();
            var invalidFields = form.querySelectorAll(':invalid');
            invalidFields.forEach(function(field) {
                var label = form.querySelector('label[for="' + field.id + '"]');
                if (label) {
                label.classList.add('invalid');
                }
                field.classList.add('is-invalid');
            });
            } else {
            var labels = form.querySelectorAll('label.invalid');
            labels.forEach(function(label) {
                label.classList.remove('invalid');
            });
            var invalidFields = form.querySelectorAll('.is-invalid');
            invalidFields.forEach(function(field) {
                field.classList.remove('is-invalid');
            });
            }
            form.classList.add('was-validated');
        }, false);
        });
    }, false);
    })();

    // Submit form on button click
    document.getElementById('submitButton').addEventListener('click', function(event) {
    const deliveryForm = document.getElementById('deliveryForm');
    const paymentForm = document.getElementById('paymentForm');
    const orderForm = document.querySelector('.order');
    let isValid = true;

    if (!deliveryForm.checkValidity()) {
        deliveryForm.classList.add('was-validated');
        isValid = false;
    }

    if (!paymentForm.checkValidity()) {
        paymentForm.classList.add('was-validated');
        isValid = false;
    }

    /*Ë≠¶Á§∫‰ªçÊúâÊ¨Ñ‰ΩçÊú™Â°´Â¶•*/
    if (!isValid) {
        alert("Ë´ãÂ°´ÂØ´ÊâÄÊúâÂøÖÂ°´Ê¨Ñ‰Ωç");
    } else {
        orderForm.submit();
        alert("‚úÖ ÁµêÂ∏≥ÊàêÂäü");
    }

    // Prevent default form submission
    event.preventDefault();
    });

    </script>

    <style>
        .is-invalid {
            border-color: #dc3545 !important;
        }
        .invalid {
            color: #dc3545 !important;
        }
    </style>

    <!-- ÂõûÂà∞È†ÇÈÉ®ÊåâÈàï -->
    <div class="slider">
    <a href="#">
        <div class="top">
            <iconify-icon icon="iconoir:page-up"></iconify-icon>
        </div>
    </a>
    </div>

      <!-- footerÈ†ÅÂ∞æ(Âê´ËÅØÁµ°Ë≥áË®ä) 
      ================================================== -->
      <jsp:include page="./footer.jsp" />

    <!-- Javascript ÂçÄÂüü -->
    <script src="./assets/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>
    <script async src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha384-GNFwBvfVxBkLMJpYMOABq3c+d3KnQxudP/mGPkzpZSTYykLBNsZEnG2D9G/X/+7D" crossorigin="anonymous"></script></body>

  </body>
  
</html>
